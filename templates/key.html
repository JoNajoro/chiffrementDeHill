<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion des Clés</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h3>Gestion des Clés</h3>
        {% if session.user %}
            <p>Bonjour, {{ session.user.nom }} | <a href="{{ url_for('auth.logout') }}">Déconnexion</a></p>
        {% endif %}
        <hr>
    </header>

    <main>
        <section>
            <h2>Liste des Clés</h2>
            <button onclick="loadKeys()" style="margin-bottom: 10px;">Rafraîchir la liste</button>
            <table border="1">
                <thead>
                    <tr>
                        <th>Email du Destinataire</th>
                        <th>Clé</th>
                        <th>Niveau de Difficulté</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="keys-list">
                    <!-- Les clés seront chargées ici via JavaScript -->
                </tbody>
            </table>
        </section>

        <section>
            <h2>Générer une Nouvelle Clé</h2>
            <form id="generate-key-form">
                <label for="receiver_email">Email du Destinataire:</label>
                <input type="email" id="receiver_email" name="receiver_email" required>
                
                <label for="difficulty">Niveau de Difficulté:</label>
                <select id="difficulty" name="difficulty" required>
                    <option value="5">Facile (5x5)</option>
                    <option value="15">Moyen (15x15)</option>
                    <option value="50">Difficile (50x50)</option>
                </select>
                
                <button type="submit">Générer la Clé</button>
            </form>
            
            <div id="generated-key" style="display: none; margin-top: 20px;">
                <h3>Clé Générée:</h3>
                <p id="key-value"></p>
                <p>Copiez cette clé et partagez-la avec le destinataire.</p>
            </div>
        </section>
    </main>

    <script>
        // Fonction pour charger les clés
        function loadKeys() {
            fetch('/get_all_stored_keys')
                .then(response => response.json())
                .then(data => {
                    console.log('Données reçues:', data); // Message de débogage
                    const keysList = document.getElementById('keys-list');
                    keysList.innerHTML = ''; // Effacer le contenu actuel
                    if (data.success) {
                        if (data.keys.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td colspan="4">Aucune clé disponible.</td>
                            `;
                            keysList.appendChild(row);
                        } else {
                            data.keys.forEach(key => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${key.receiver_email}</td>
                                    <td>${key.key}</td>
                                    <td>${getDifficultyLevel(key.key)}</td>
                                    <td>
                                        <button onclick="copyKey('${key.key}')">Copier</button>
                                        <button onclick="deleteKey('${key.receiver_email}')" style="margin-left: 10px;">Supprimer</button>
                                    </td>
                                `;
                                keysList.appendChild(row);
                            });
                        }
                    } else {
                        console.error('Erreur lors du chargement des clés:', data.error);
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="4">Erreur lors du chargement des clés: ${data.error}</td>
                        `;
                        keysList.appendChild(row);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    const keysList = document.getElementById('keys-list');
                    keysList.innerHTML = ''; // Effacer le contenu actuel
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="4">Erreur lors du chargement des clés.</td>
                    `;
                    keysList.appendChild(row);
                });
        }

        // Charger les clés existantes au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            loadKeys();
        });

        // Fonction pour déterminer le niveau de difficulté en fonction de la longueur de la clé
        function getDifficultyLevel(key) {
            if (key.length === 36) {
                return 'Facile (5x5)';
            } else if (key.length === 300) {
                return 'Moyen (15x15)';
            } else if (key.length === 3336) {
                return 'Difficile (50x50)';
            } else {
                return 'Inconnu';
            }
        }

        // Fonction pour copier une clé
        function copyKey(key) {
            navigator.clipboard.writeText(key)
                .then(() => {
                    alert('Clé copiée dans le presse-papiers!');
                })
                .catch(error => {
                    alert(`Erreur lors de la copie: ${error}`);
                });
        }

        // Fonction pour supprimer une clé
        function deleteKey(receiverEmail) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette clé?')) {
                fetch(`/delete_key?receiver_email=${encodeURIComponent(receiverEmail)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Clé supprimée avec succès!');
                            // Recharger la liste des clés
                            location.reload();
                        } else {
                            alert('Erreur lors de la suppression de la clé: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        alert('Erreur lors de la suppression de la clé.');
                    });
            }
        }

        // Gestionnaire de soumission du formulaire de génération de clé
        document.getElementById('generate-key-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const receiverEmail = document.getElementById('receiver_email').value;
            const difficulty = document.getElementById('difficulty').value;
            
            fetch(`/generate_key?receiver_email=${encodeURIComponent(receiverEmail)}&size=${difficulty}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('key-value').textContent = data.key;
                        document.getElementById('generated-key').style.display = 'block';
                        
                        // Recharger la liste des clés
                        location.reload();
                    } else {
                        alert('Erreur lors de la génération de la clé: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la génération de la clé.');
                });
        });
    </script>
</body>
</html>