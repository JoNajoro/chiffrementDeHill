{% extends 'base.html' %}

{% block title %}Notifications{% endblock %}

{% block content %}
<h2>Notifications</h2>
<div id="notifications-container">
    {% if notifications %}
    <ul>
        {% for notification in notifications %}
        <li id="notification-{{ notification._id }}" style="background-color: {% if not notification.is_read %}#f8d7da{% else %}#d4edda{% endif %}; padding: 10px; margin-bottom: 10px; border-radius: 5px;">
            <strong>De:</strong> {{ notification.sender_email }}<br>
            <strong>Message:</strong> {{ notification.original_key }}<br>
            <small>{{ notification.timestamp }}</small>
            {% if not notification.is_read %}
            - <button onclick="markAsRead('{{ notification._id }}')" style="background: none; border: none; color: blue; text-decoration: underline; cursor: pointer;">Marquer comme lu</button>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>Aucune notification.</p>
    {% endif %}
</div>
<a href="{{ url_for('main.index') }}">Retour au tableau de bord</a>

<script>
function markAsRead(notificationId) {
    fetch(`/mark_notification_as_read/${notificationId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Changer la couleur de fond de la notification
            const notificationElement = document.getElementById(`notification-${notificationId}`);
            if (notificationElement) {
                notificationElement.style.backgroundColor = '#d4edda';
                // Supprimer le bouton "Marquer comme lu"
                const button = notificationElement.querySelector('button');
                if (button) {
                    button.remove();
                }
            }

            // Le badge sera mis à jour au prochain rechargement de la page
            // Pas de mise à jour en temps réel
        } else {
            alert('Erreur lors de la mise à jour de la notification: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la mise à jour de la notification');
    });
}

function updateDashboardBadge(unreadCount) {
    // Mettre à jour le badge des notifications sur cette page
    if (typeof updateNotificationBadge === 'function') {
        updateNotificationBadge(unreadCount);
    }
}
</script>
{% endblock %}