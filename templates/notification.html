<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boîte de Notifications</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .notification-box {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
            cursor: default;
            transition: background-color 0.3s;
        }
        .notification-box:hover {
            background-color: #e9e9e9;
        }
        .notification-unread {
            border-left: 4px solid #007bff;
            background-color: #f0f8ff;
        }
        .notification-read {
            border-left: 4px solid #6c757d;
            background-color: #f8f9fa;
        }
        .notification-sender {
            font-weight: bold;
            color: #007bff;
        }
        .notification-key {
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .notification-key-hidden {
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .key-actions {
            display: inline-flex;
            gap: 5px;
            margin-left: 10px;
        }
        .key-actions button {
            padding: 2px 5px;
            font-size: 12px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="text-center mb-4">Boîte de Notifications</h2>
        <div class="card">
            <div class="card-body">
                <div id="notifications-list">
                    <!-- Les notifications seront ajoutées dynamiquement ici -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal pour la vérification du mot de passe -->
    <div class="modal fade" id="passwordModal" tabindex="-1" role="dialog" aria-labelledby="passwordModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passwordModalLabel">Vérification de mot de passe</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Fermer">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Veuillez entrer votre mot de passe pour afficher la clé :</p>
                    <input type="password" class="form-control" id="passwordInput" placeholder="Mot de passe">
                    <div id="passwordError" class="text-danger mt-2" style="display: none;">
                        Mot de passe incorrect. Veuillez réessayer.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="verifyPassword()">Vérifier</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery et Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
    <script>
        // Variables globales pour stocker l'état
        let currentNotificationId = null;
        let currentKeyToShow = null;
        
        // Fonction pour récupérer les notifications depuis le backend
        async function fetchNotifications() {
            try {
                const response = await fetch('/get_notifications');
                const data = await response.json();
                
                if (data.success) {
                    return data.notifications;
                } else {
                    console.error('Échec de la récupération des notifications:', data.error);
                    return [];
                }
            } catch (error) {
                console.error('Erreur lors de la récupération des notifications:', error);
                return [];
            }
        }
        
        // Fonction pour afficher les notifications
        async function displayNotifications() {
            const notifications = await fetchNotifications();
            const notificationsList = document.getElementById('notifications-list');
            notificationsList.innerHTML = '';
            
            if (notifications.length === 0) {
                notificationsList.innerHTML = '<p class="text-center text-muted">Aucune notification pour le moment.</p>';
                return;
            }
            
            notifications.forEach(notification => {
                const notificationBox = document.createElement('div');
                notificationBox.className = `notification-box ${notification.is_read ? 'notification-read' : 'notification-unread'}`;
                // Suppression du onclick sur la notification entière pour éviter les conflits
                
                // Créer un ID unique pour chaque notification
                const notificationId = `notification-${Math.random().toString(36).substr(2, 9)}`;
                
                // Utiliser la clé originale si disponible, sinon utiliser la clé hachée
                const keyToDisplay = notification.original_key || notification.key;
                const keyLabel = notification.original_key ? "Clé originale" : "Clé hachée";
                
                notificationBox.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="notification-sender">${notification.sender}</span>
                            vous a envoyé un message avec la ${keyLabel} :
                            <span class="notification-key-hidden" id="${notificationId}-hidden">********</span>
                            <span class="notification-key" id="${notificationId}-visible" style="display: none;"></span>
                            <div class="key-actions">
                                <button class="btn btn-sm btn-outline-primary toggle-key-btn" data-notification-id="${notificationId}" onclick="event.stopPropagation(); showPasswordModal('${notificationId}', '${keyToDisplay}')">Afficher</button>
                                <button class="btn btn-sm btn-outline-secondary copy-key-btn" data-notification-id="${notificationId}" data-key="${keyToDisplay}" onclick="event.stopPropagation(); copyKey('${keyToDisplay}')" disabled>Copier</button>
                                <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); goToChat('${notification.sender}')">Aller vers la discussion</button>
                            </div>
                            <div class="text-muted small">${notification.timestamp}</div>
                        </div>
                        <div>
                            ${notification.is_read ? '<span class="badge badge-secondary">Lu</span>' : '<span class="badge badge-primary">Nouveau</span>'}
                            <i class="fas fa-chevron-right text-muted ml-2"></i>
                        </div>
                    </div>
                `;
                notificationsList.appendChild(notificationBox);
            });
        }
        
        // Fonction pour afficher la modal de mot de passe
        function showPasswordModal(notificationId, key) {
            currentNotificationId = notificationId;
            currentKeyToShow = key;
            $('#passwordModal').modal('show');
        }
        
        // Fonction pour vérifier le mot de passe
        async function verifyPassword() {
            const password = document.getElementById('passwordInput').value;
            
            if (!password) {
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordError').textContent = 'Veuillez entrer un mot de passe.';
                return;
            }
            
            try {
                const response = await fetch('/verify_password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({password: password})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Mot de passe correct, afficher la clé
                    $('#passwordModal').modal('hide');
                    showKey(currentNotificationId, currentKeyToShow);
                    
                    // Réinitialiser les champs
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('passwordError').style.display = 'none';
                } else {
                    // Mot de passe incorrect
                    document.getElementById('passwordError').style.display = 'block';
                    document.getElementById('passwordError').textContent = 'Mot de passe incorrect. Veuillez réessayer.';
                }
            } catch (error) {
                console.error('Erreur lors de la vérification du mot de passe:', error);
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordError').textContent = 'Erreur lors de la vérification du mot de passe.';
            }
        }
        
        // Fonction pour afficher la clé (après vérification du mot de passe)
        function showKey(notificationId, key) {
            const hiddenKey = document.getElementById(`${notificationId}-hidden`);
            const visibleKey = document.getElementById(`${notificationId}-visible`);
            const toggleButton = document.querySelector(`.toggle-key-btn[data-notification-id="${notificationId}"]`);
            const copyButton = document.querySelector(`.copy-key-btn[data-notification-id="${notificationId}"]`);
            
            if (hiddenKey && visibleKey) {
                hiddenKey.style.display = 'none';
                visibleKey.style.display = 'inline-block';
                visibleKey.textContent = key;
                
                // Changer le bouton en "Masquer"
                if (toggleButton) {
                    toggleButton.textContent = 'Masquer';
                    toggleButton.onclick = function(event) {
                        event.stopPropagation();
                        hideKey(notificationId);
                    };
                }
                
                // Activer le bouton Copier
                if (copyButton) {
                    copyButton.disabled = false;
                }
            }
        }
        
        // Fonction pour masquer la clé
        function hideKey(notificationId) {
            const hiddenKey = document.getElementById(`${notificationId}-hidden`);
            const visibleKey = document.getElementById(`${notificationId}-visible`);
            const toggleButton = document.querySelector(`.toggle-key-btn[data-notification-id="${notificationId}"]`);
            const copyButton = document.querySelector(`.copy-key-btn[data-notification-id="${notificationId}"]`);
            
            if (hiddenKey && visibleKey) {
                hiddenKey.style.display = 'inline-block';
                visibleKey.style.display = 'none';
                
                // Changer le bouton en "Afficher"
                if (toggleButton) {
                    toggleButton.textContent = 'Afficher';
                    toggleButton.onclick = function(event) {
                        event.stopPropagation();
                        showPasswordModal(notificationId, currentKeyToShow);
                    };
                }
                
                // Désactiver le bouton Copier
                if (copyButton) {
                    copyButton.disabled = true;
                }
            }
        }
        
        // Fonction pour rediriger vers la page de chat (même implémentation que le bouton "Discuter")
        function goToChat(senderEmail) {
            // Générer l'URL de la même manière que url_for('main.chat', user_email=senderEmail)
            // La route est définie comme /chat/<user_email>, donc nous utilisons ce format
            // Encoder l'email pour gérer les caractères spéciaux comme @, +, etc.
            const encodedEmail = encodeURIComponent(senderEmail);
            window.location.href = `/chat/${encodedEmail}`;
            console.log(`Redirection vers /chat/${encodedEmail}`); // Pour le débogage
        }
        
        // Fonction pour copier la clé dans le presse-papiers
        function copyKey(key) {
            navigator.clipboard.writeText(key).then(() => {
                alert('Clé copiée dans le presse-papiers !');
            }).catch(err => {
                console.error('Échec de la copie de la clé: ', err);
            });
        }
        
        // Afficher les notifications lorsque la page est chargée
        window.onload = displayNotifications;
    </script>
</body>
</html>